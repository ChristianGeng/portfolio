<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of prompter_NIDAQ</title>
  <meta name="keywords" content="prompter_NIDAQ">
  <meta name="description" content="prompterNDI_NIDAQ Prompt program for NDI wave system, also controlling">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">NDIWAVES</a> &gt; prompter_NIDAQ.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for NDIWAVES&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>prompter_NIDAQ
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>prompterNDI_NIDAQ Prompt program for NDI wave system, also controlling</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function prompterNDI_NIDAQ(stimfile,logfile,trial_duration,fontsize,aDaqNameCommon,startwav,endwav); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> prompterNDI_NIDAQ Prompt program for NDI wave system, also controlling
 NIDAQ compact DAQ card 
 function prompterNDI(stimfile,logfile,trial_duration,fontsize,startwav,endwav,mysynchline);
 prompter_parallel: Version 09.10.11

    Syntax
        fontsize: Size of font for stimulus display to subject. Given in
            normalized units
        trial_duration: in s. If empty, stop interactively (key press)
        startwav and endwav (optional). WAV files played at start and end, respectively
                could be just a bell, but could also be e.g a synch
                inpulse.
        mysynchline: Optional, default to 8. Specifies the output line of
            the parallel port to use for synch signal.
            Set to 8 if using the additional connection on the special box used
            at Munich to connect the parallel port input to the AG500 and the output to the VTG55
            video timer.
            Set to 1 if using a cable like that used for synch output from Phil's version
            of the AG100 software

   Description
       Outputs synch signal to parallel port at start of trial.
       Simple version of prompter_parallel_trigin, without video timer
       control and monitoring of AG500 status
       This version can be used when daq toolbox access to parallel port
       not available.
       Thus also useful for testing integrity of prompt files before
       experiment because it can be run when parallel port in not
       accessible (this requires administrator privileges on Windows XP
       It is intended that this program will eventually be merged with
       prompter_parallel_trigin etc.
        See prompter_parallel_trigin or prompter_parallel_trigag for more
        up-to-date help.
       Note: unlike prompter_parallel_trigin etc. this version has no code
       for optional handling of vt220 serial terminal

   See Also PROMPTER_PARALLEL_TRIGIN, PROMPTER_PARALLEL_TRIGAG

    Updates
        10.10 synchline made configurable. 'comment' command works as in
        prompter_parallel_trigin etc.
       08.11 Add userstart/stop functions (see source code for details)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="dataaqNIonly.html" class="code" title="function [lh]=dataaqNIonly(src,event)">dataaqNIonly</a>	% DOCUMENT TITLE</li><li><a href="wave_connect.html" class="code" title="function [s] = wave_connect (timeoutin)">wave_connect</a>	WAVE_CONNECT --- establish socket connection to NDI RT Server</li><li><a href="wave_negPackage.html" class="code" title="function [p] = wave_negPackage (s,q,averbose)">wave_negPackage</a>	WAVE_NEGPACKAGE - negotiate NDI wave packages with the NDI RT server.</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">functionname=</a></li><li><a href="#_sub2" class="code">function showg(ht,mys);</a></li><li><a href="#_sub3" class="code">function updatefigs</a></li><li><a href="#_sub4" class="code">function dotrafficlights(tlcol,ht,figh);</a></li><li><a href="#_sub5" class="code">function showhelp</a></li></ul>
<h2><a name="_download"></a>DOWNLOAD <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<p><a href="prompter_NIDAQ.m">prompter_NIDAQ.m</a></p>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function prompterNDI_NIDAQ(stimfile,logfile,trial_duration,fontsize,aDaqNameCommon,startwav,endwav);</a>
0002 <span class="comment">% prompterNDI_NIDAQ Prompt program for NDI wave system, also controlling</span>
0003 <span class="comment">% NIDAQ compact DAQ card</span>
0004 <span class="comment">% function prompterNDI(stimfile,logfile,trial_duration,fontsize,startwav,endwav,mysynchline);</span>
0005 <span class="comment">% prompter_parallel: Version 09.10.11</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%    Syntax</span>
0008 <span class="comment">%        fontsize: Size of font for stimulus display to subject. Given in</span>
0009 <span class="comment">%            normalized units</span>
0010 <span class="comment">%        trial_duration: in s. If empty, stop interactively (key press)</span>
0011 <span class="comment">%        startwav and endwav (optional). WAV files played at start and end, respectively</span>
0012 <span class="comment">%                could be just a bell, but could also be e.g a synch</span>
0013 <span class="comment">%                inpulse.</span>
0014 <span class="comment">%        mysynchline: Optional, default to 8. Specifies the output line of</span>
0015 <span class="comment">%            the parallel port to use for synch signal.</span>
0016 <span class="comment">%            Set to 8 if using the additional connection on the special box used</span>
0017 <span class="comment">%            at Munich to connect the parallel port input to the AG500 and the output to the VTG55</span>
0018 <span class="comment">%            video timer.</span>
0019 <span class="comment">%            Set to 1 if using a cable like that used for synch output from Phil's version</span>
0020 <span class="comment">%            of the AG100 software</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%   Description</span>
0023 <span class="comment">%       Outputs synch signal to parallel port at start of trial.</span>
0024 <span class="comment">%       Simple version of prompter_parallel_trigin, without video timer</span>
0025 <span class="comment">%       control and monitoring of AG500 status</span>
0026 <span class="comment">%       This version can be used when daq toolbox access to parallel port</span>
0027 <span class="comment">%       not available.</span>
0028 <span class="comment">%       Thus also useful for testing integrity of prompt files before</span>
0029 <span class="comment">%       experiment because it can be run when parallel port in not</span>
0030 <span class="comment">%       accessible (this requires administrator privileges on Windows XP</span>
0031 <span class="comment">%       It is intended that this program will eventually be merged with</span>
0032 <span class="comment">%       prompter_parallel_trigin etc.</span>
0033 <span class="comment">%        See prompter_parallel_trigin or prompter_parallel_trigag for more</span>
0034 <span class="comment">%        up-to-date help.</span>
0035 <span class="comment">%       Note: unlike prompter_parallel_trigin etc. this version has no code</span>
0036 <span class="comment">%       for optional handling of vt220 serial terminal</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%   See Also PROMPTER_PARALLEL_TRIGIN, PROMPTER_PARALLEL_TRIGAG</span>
0039 <span class="comment">%</span>
0040 <span class="comment">%    Updates</span>
0041 <span class="comment">%        10.10 synchline made configurable. 'comment' command works as in</span>
0042 <span class="comment">%        prompter_parallel_trigin etc.</span>
0043 <span class="comment">%       08.11 Add userstart/stop functions (see source code for details)</span>
0044 
0045 <a name="_sub1" href="#_subfunctions" class="code">functionname=</a><span class="string">'PROMPTER_PARALLEL: Version 21.08.2011'</span>;
0046 
0047 <span class="keyword">global</span> DAQData srate nSampsAcquired datsize nchan unit NIsession private daqOutFile
0048 
0049 
0050 philcom(1)
0051 imageprefix=<span class="string">'&lt;IMAGE&gt;'</span>;
0052 
0053 <span class="comment">%synchline=8;        %compatible with vtgctrl (otherwise use 1)</span>
0054 <span class="comment">%synchline=1;</span>
0055 
0056 
0057 
0058 wavlist=[];
0059 wavlistsynch=0;        <span class="comment">%12.09</span>
0060 
0061 <span class="comment">%matlab commands, or script or function file, to be executed at start and</span>
0062 <span class="comment">%end of trial (i.e the string specified here is passed to the eval</span>
0063 <span class="comment">%function)</span>
0064 <span class="comment">%Using a function is preferable, to reduce chances of inadvertently</span>
0065 <span class="comment">%changing program variables</span>
0066 <span class="comment">%This mechanism could be used as an alternative way of handling audio</span>
0067 <span class="comment">%output depending on current stimulus. Should mainly be useful for</span>
0068 <span class="comment">%modifying the prompt display in various ways.</span>
0069 <span class="comment">%could also be used to enforce a minimum 'getready' duration.</span>
0070 
0071 userstopfunc=<span class="string">''</span>; <span class="comment">%called at end of trial, just before new stimulus is displayed (so e.g could be used to make</span>
0072 <span class="comment">%stimulus invisible until the next 'next' command</span>
0073 userstartfunc=<span class="string">''</span>; <span class="comment">%called during the next command, before start of trial. Specifically, after any audio</span>
0074 <span class="comment">%output specified in wavlist has been done.</span>
0075 <span class="comment">% In prompter_parallel_trigag it is called before the signal to the AG500</span>
0076 <span class="comment">% control server to start the trial</span>
0077 <span class="comment">% In prompter_parallel_trigin it is called before the program waits for the</span>
0078 <span class="comment">% attention signal.</span>
0079 <span class="comment">% Future versions for ag500 control may include separate functions linked</span>
0080 <span class="comment">% to the attention and sweep signals</span>
0081 
0082 <span class="comment">%</span>
0083 <span class="comment">% daqok=1;</span>
0084 <span class="comment">% try</span>
0085 <span class="comment">%     parport = digitalio('parallel','LPT1');</span>
0086 <span class="comment">%     lines_OUT_1 = addline(parport,[0:7],0,'out');</span>
0087 <span class="comment">%</span>
0088 <span class="comment">%     putvalue(parport.Line(synchline),0);</span>
0089 <span class="comment">% catch</span>
0090 <span class="comment">%     disp('parallel port not available, try logging in as administrator');</span>
0091 <span class="comment">%     daqok=0;</span>
0092 <span class="comment">% end;</span>
0093 
0094 
0095 [abint,abnoint,abscalar,abnoscalar]=abartdef;
0096 
0097 wavstart=[];
0098 <span class="keyword">if</span> nargin&gt;5
0099     wavstart=startwav;
0100     <span class="keyword">if</span> ~isempty(wavstart)
0101         [wavstart_d,wavstart_sf,wavstart_bits]=wavread(wavstart);
0102     <span class="keyword">end</span>;
0103 <span class="keyword">end</span>;
0104 
0105 wavend=[];
0106 <span class="keyword">if</span> nargin&gt;6
0107     wavend=endwav;
0108     
0109     <span class="keyword">if</span> ~isempty(wavend)
0110         [wavend_d,wavend_sf,wavend_bits]=wavread(wavstart);
0111     <span class="keyword">end</span>;
0112 <span class="keyword">end</span>;
0113 
0114 <span class="comment">% prepare COMPACTDAQ</span>
0115 daqNameCommon=<span class="string">'daqdat_'</span>;
0116 <span class="keyword">if</span> nargin&gt;4
0117  daqNameCommon=aDaqNameCommon;
0118 <span class="keyword">end</span>
0119 
0120 
0121 <span class="comment">%% SETUP DAQ</span>
0122 hfDAQ=figure(<span class="string">'Tag'</span>,<span class="string">'hfDAQ'</span>);
0123 subplot(1,1,1)
0124 <span class="comment">%set(gca,'Ylim',[-5 5])</span>
0125 <span class="comment">%subplot(2,1,2)</span>
0126 set(gca,<span class="string">'Ylim'</span>,[-5 5])
0127 
0128 daqdatindex=0; 
0129 <span class="comment">%daqOutFile=[daqNameCommon int2str0vec(daqdatindex)];</span>
0130 
0131 daqreset
0132 vendor=daq.getVendors;
0133 
0134 NIsession = daq.createSession (vendor.ID);
0135 nchanNI9234=1;
0136 nchan9215=0;
0137 <span class="comment">%srate=25600;</span>
0138 srate=51200;
0139 
0140 <span class="comment">%set(NIsession,'DurationInSeconds',nsecs)</span>
0141 set(NIsession,<span class="string">'IsContinuous'</span>,1);
0142 <span class="comment">%notifytime=srate/4;</span>
0143 <span class="comment">%set(NIsession,'NotifyWhenDataAvailableExceeds',notifytime);</span>
0144  <span class="comment">%2560</span>
0145 devs=daq.getDevices;
0146 
0147 <span class="comment">% first  nchanNI9234 channels</span>
0148 <span class="comment">%[channels,indexes]=NIsession.addAnalogInputChannel(devs(1).ID,0:nchanNI9234-1,'voltage');</span>
0149 <span class="comment">% second channel</span>
0150 [channels,indexes]=NIsession.addAnalogInputChannel(devs(1).ID,1,<span class="string">'voltage'</span>);
0151 
0152 <span class="comment">%[channelsM2,indexesM2]=NIsession.addAnalogInputChannel(devs(2).ID,0:nchan9215-1,'voltage')</span>
0153 <span class="comment">%set(channels,'Name',str2mat('Synch NDI Wave', 'Audio Participant'));</span>
0154 <span class="comment">%set(channels(1),'Name',str2mat('Synch NDI Wave'))</span>
0155 set(channels(1),<span class="string">'Name'</span>,str2mat(<span class="string">'Audio Participant'</span>))
0156 
0157 <span class="comment">%NIsession.removeChannel(1)</span>
0158 set(NIsession,<span class="string">'Rate'</span>,srate)
0159 [lh]=NIsession.addlistener(<span class="string">'DataAvailable'</span>, @<a href="dataaqNIonly.html" class="code" title="function [lh]=dataaqNIonly(src,event)">dataaqNIonly</a>);
0160 
0161 <span class="comment">%NIsession.addlistener('ErrorOccurred', @devicewarn);</span>
0162 <span class="comment">% function devicewarn(src,event)</span>
0163 
0164 NIChannels=get(NIsession,<span class="string">'Channels'</span>); 
0165 NIChanProps=get(NIChannels);
0166 nchan=length(NIChanProps);
0167 
0168 private.devs=get(devs);
0169 private.NISession=get(NIsession);
0170 private.channels=get(channels);
0171 private.vendor=get(vendor);
0172 unit=cat(1,private.channels.MeasurementType);
0173 
0174 mymem=memory;
0175 nbytes=8; <span class="comment">% DAQ data are 32bit long</span>
0176 <span class="comment">%nsecs=3600*3; %% Allocate 3h of data ...</span>
0177 <span class="comment">%nsecs=800; %% allocate space for measurement data ...</span>
0178 nsecs=floor(mymem.MaxPossibleArrayBytes/(nchan*nbytes*srate));
0179 disp([<span class="string">'There is space for '</span> num2str(nsecs/3600) <span class="string">'h of data!'</span>]);
0180 <span class="comment">%nsecs=2600; % das geht noch (3/4 Stunde)</span>
0181 nsecs=240;
0182 datsize=nsecs*srate;
0183 
0184 NDIconn=0;
0185 <span class="keyword">if</span> NDIconn
0186 <span class="comment">% prepare NDI WAVE:</span>
0187 [s] = <a href="wave_connect.html" class="code" title="function [s] = wave_connect (timeoutin)">wave_connect</a>(2900)
0188 <span class="comment">%s.getSoTimeout</span>
0189 
0190 q.data=<span class="string">'Version 1.0'</span>;
0191 q.type=1;
0192 p = <a href="wave_negPackage.html" class="code" title="function [p] = wave_negPackage (s,q,averbose)">wave_negPackage</a> (s,q);
0193 disp(char(p.data'))
0194 
0195 <span class="comment">% cString = 'SetByteOrder LittleEndian' 'false'</span>
0196 q.data=<span class="string">'SetByteOrder LittleEndian'</span>;
0197 q.type=1;
0198 p = <a href="wave_negPackage.html" class="code" title="function [p] = wave_negPackage (s,q,averbose)">wave_negPackage</a> (s,q);
0199 
0200 disp(char(p.data'));
0201 <span class="comment">% vieilleicht bessere Latenz??</span>
0202 s.setTcpNoDelay(true)
0203 
0204 qStart=assembleStartRecordingPacket;
0205 qStop=assembleStartRecordingPacket(0);
0206 <span class="keyword">end</span>
0207 
0208 <span class="comment">%if true, program continues without waiting for end of sound</span>
0209 wavstart_async=0;
0210 wavend_async=0;
0211 
0212 [ps,cs,s1line,nstim,nline,prepareimage,maxcol]=parsestimfile(stimfile);
0213 
0214 helpwin prompter_parallel;
0215 
0216 helpwin(s1line,stimfile);
0217 
0218 
0219 fid=fopen(logfile,<span class="string">'w'</span>);
0220 <span class="keyword">if</span> fid&lt;3
0221     disp(<span class="string">'unable to open log file'</span>);
0222     <span class="keyword">return</span>
0223 <span class="keyword">end</span>;
0224 ts=[<span class="string">'&lt;'</span> <a name="_sub2" href="#_subfunctions" class="code">functionname </a><span class="string">'&gt;'</span> crlf];
0225 status=fwrite(fid,ts,<span class="string">'uchar'</span>);
0226 <span class="keyword">if</span> status~=length(ts)
0227     disp(<span class="string">'Problem writing to log file'</span>);
0228     fclose(fid);
0229     <span class="keyword">return</span>;
0230 <span class="keyword">end</span>;
0231 
0232 
0233 hfsub=figure;
0234 set(hfsub,<span class="string">'color'</span>,<span class="string">'w'</span>);
0235 set(hfsub,<span class="string">'menu'</span>,<span class="string">'none'</span>);
0236 haxp=axes;
0237 xlim([0 1]);
0238 ylim([0 1]);
0239 set(gca,<span class="string">'visible'</span>,<span class="string">'off'</span>);
0240 set(gca,<span class="string">'position'</span>,[0.05 0.05 0.9 0.9]);
0241 
0242 ht=text(0.5,0.5,<span class="string">'***'</span>,<span class="string">'horizontalalignment'</span>,<span class="string">'left'</span>,<span class="string">'verticalalignment'</span>,<span class="string">'middle'</span>);
0243 set(ht,<span class="string">'fontunits'</span>,<span class="string">'normalized'</span>,<span class="string">'fontsize'</span>,fontsize,<span class="string">'userdata'</span>,fontsize,<span class="string">'tag'</span>,<span class="string">'prompt'</span>);
0244 
0245 set(ht,<span class="string">'edgecolor'</span>,<span class="string">'r'</span>,<span class="string">'linewidth'</span>,5,<span class="string">'margin'</span>,15);
0246 
0247 haxsub=gca;
0248 set(hfsub,<span class="string">'name'</span>,<span class="string">'Subject'</span>);
0249 
0250 haxi=[];
0251 <span class="comment">%vi=strmatch(imageprefix,ps);</span>
0252 <span class="comment">%if ~isempty(vi)</span>
0253 <span class="keyword">if</span> prepareimage
0254     disp(<span class="string">'preparing for image data'</span>);
0255     haxi=axes;
0256     set(haxi,<span class="string">'position'</span>,get(haxp,<span class="string">'position'</span>));
0257     set(haxi,<span class="string">'tag'</span>,imageprefix);
0258     hi=image;
0259     set(hi,<span class="string">'tag'</span>,imageprefix);
0260     <span class="comment">%make sure axis ticks and labels are not visible when axes is visible</span>
0261     <span class="comment">%but see note below</span>
0262     set(haxi,<span class="string">'ycolor'</span>,get(hfsub,<span class="string">'color'</span>),<span class="string">'xcolor'</span>,get(hfsub,<span class="string">'color'</span>));
0263     <span class="comment">%7.10 use axes rather than figure color to cue the subject</span>
0264     set(haxi,<span class="string">'color'</span>,<span class="string">'r'</span>,<span class="string">'linewidth'</span>,10);
0265     set(haxi,<span class="string">'visible'</span>,<span class="string">'off'</span>);
0266     set(hi,<span class="string">'visible'</span>,<span class="string">'on'</span>);
0267     
0268     disp(<span class="string">'load image data'</span>);
0269     <span class="comment">%the loading script could show one image to allow size to be checked</span>
0270     <span class="comment">%and should then normally set axis image or axis equal (not sure</span>
0271     <span class="comment">%what happens with axis image if image size varies)</span>
0272     <span class="comment">%But for the normal case of same-size images then axis image is better.</span>
0273     <span class="comment">%(axis equal will leave additional strips in the axis color with size</span>
0274     <span class="comment">%depending on precise image dimensions, - and also little notches in the</span>
0275     <span class="comment">%background color at the tick location (can be fixed with e.g</span>
0276     <span class="comment">%set(haxi,'xtick',[]);</span>
0277     <span class="comment">%example for the loading script:</span>
0278     <span class="comment">%===========================</span>
0279     <span class="comment">%set(haxi,'userdata',mymatin('mca6_medgem_images','data'));</span>
0280     
0281     <span class="comment">%assume monochrome image (not stored as truecolor)</span>
0282     <span class="comment">%if data still stored as logical use this:</span>
0283     <span class="comment">%set(get(haxi,'parent'),'colormap',gray(2));</span>
0284     <span class="comment">%otherwise if resized and antialiased, use this:</span>
0285     <span class="comment">%set(get(haxi,'parent'),'colormap',gray(256));</span>
0286     <span class="comment">%tmpxx=get(haxi,'userdata');</span>
0287     <span class="comment">%tmpxx=tmpxx{1};</span>
0288     <span class="comment">%set(hi,'cdata',tmpxx);</span>
0289     <span class="comment">%axis(haxi,'image');</span>
0290     <span class="comment">%clear tmpxx;</span>
0291     <span class="comment">%===============================</span>
0292     
0293     keyboard;
0294     set(hi,<span class="string">'visible'</span>,<span class="string">'off'</span>);
0295     
0296 <span class="keyword">end</span>;
0297 
0298 hfinv=[];
0299     hfinv=figure;
0300     set(hfinv,<span class="string">'color'</span>,get(hfsub,<span class="string">'color'</span>));
0301     set(hfinv,<span class="string">'menu'</span>,<span class="string">'none'</span>);
0302     set(hfinv,<span class="string">'colormap'</span>,get(hfsub,<span class="string">'colormap'</span>));    <span class="comment">%ensure colormaps are same, especially for image mode</span>
0303     
0304     copyobj([haxsub haxi],hfinv);
0305     ht(2)=findobj(hfinv,<span class="string">'type'</span>,<span class="string">'text'</span>,<span class="string">'tag'</span>,<span class="string">'prompt'</span>);
0306     set(hfinv,<span class="string">'name'</span>,<span class="string">'Investigator'</span>);
0307     <span class="comment">%show trial number and current time in investigator prompt window</span>
0308     <span class="comment">%make axes a bit smaller to give room for text above</span>
0309     haxinv=findobj(hfinv,<span class="string">'type'</span>,<span class="string">'axes'</span>);
0310     mypos=get(haxinv(1),<span class="string">'position'</span>);
0311     mypos(1:2)=[0.05 0.01];
0312     mynewsize=mypos(3:4)*0.85;        <span class="comment">%factor will depend on how many lines of text</span>
0313     mypos(3:4)=mynewsize;
0314     set(haxinv,<span class="string">'position'</span>,mypos);
0315     htinfo(1)=text(0,1.12+0.02,<span class="string">' '</span>,<span class="string">'fontweight'</span>,<span class="string">'bold'</span>,<span class="string">'fontunits'</span>,<span class="string">'normalized'</span>,<span class="string">'verticalalignment'</span>,<span class="string">'bottom'</span>);
0316     htinfo(2)=text(0,1.02,<span class="string">' '</span>,<span class="string">'fontweight'</span>,<span class="string">'bold'</span>,<span class="string">'fontunits'</span>,<span class="string">'normalized'</span>,<span class="string">'verticalalignment'</span>,<span class="string">'bottom'</span>,<span class="string">'interpreter'</span>,<span class="string">'none'</span>);
0317     set(htinfo,<span class="string">'fontsize'</span>,0.1,<span class="string">'erasemode'</span>,<span class="string">'xor'</span>);
0318     set(hfinv,<span class="string">'doublebuffer'</span>,<span class="string">'on'</span>);
0319     
0320     <span class="comment">%could be used to indicate stopped/running if normal traffic lights are not</span>
0321     <span class="comment">%used for this (or if not visible on video)</span>
0322     htinforuncol=<span class="string">'k'</span>;
0323     htinfostopcol=<span class="string">'k'</span>;
0324     
0325 
0326 figh=[hfsub hfinv];
0327 
0328 
0329 P.figurebasecolor=get(hfsub,<span class="string">'color'</span>);
0330 P.promptmode=<span class="string">'text'</span>;
0331 P.imageprefix=imageprefix;
0332 set(hfsub,<span class="string">'userdata'</span>,P);
0333 
0334 
0335 <span class="comment">%colors for signal to subject</span>
0336 <span class="comment">%normal colours</span>
0337 TL.stop=[1 0 0];
0338 TL.go=[0.1 0.8 0.1];
0339 TL.getready=[1 1 0];
0340 
0341 <span class="comment">%no change in colours</span>
0342 <span class="comment">%TL.stop=[0 0 0];</span>
0343 <span class="comment">%TL.go=[0 0 0];</span>
0344 <span class="comment">%TL.getready=[0 0 0];</span>
0345 
0346 
0347 
0348 
0349 <span class="comment">%can also adjust text properties, traffic light colours  etc. by hand</span>
0350 <span class="comment">%can also adjust text properties, traffic light colours etc. by hand</span>
0351 disp(<span class="string">'Position Subject, Investigator and Help figures, then type return'</span>);
0352 disp(<span class="string">'(Optionally adjust other settings)'</span>);
0353 keyboard;
0354 
0355 <a href="#_sub4" class="code" title="subfunction dotrafficlights(tlcol,ht,figh);">dotrafficlights</a>(TL.stop,ht,figh);
0356 
0357 drawnow;
0358 <a href="#_sub3" class="code" title="subfunction updatefigs">updatefigs</a>;
0359 <span class="comment">%set(gcf,'menu','none')</span>
0360 
0361 all_done=0;
0362 irun=1;
0363 <a href="#_sub5" class="code" title="subfunction showhelp">showhelp</a>;
0364 
0365 <span class="keyword">while</span> ~all_done
0366     ts=datestr(now);
0367     ts=[<span class="string">'&lt;Start of Sequence&gt; '</span> ts crlf];
0368     status=fwrite(fid,ts,<span class="string">'uchar'</span>);
0369     <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,<span class="string">'\fontname{Helvetica}!New Sequence!'</span>);
0370     <span class="comment">%   showg(ht,str2mat('!new!','!sequence!'));</span>
0371     disp(<span class="string">'Starting prompt sequence'</span>);
0372     disp(<span class="string">'hit any key to continue'</span>);
0373     pause;
0374     
0375     istim=1;
0376     repeatstr=<span class="string">''</span>;
0377     rubbishstr=<span class="string">''</span>;
0378     <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,ps{istim});
0379     <span class="comment">%   set(ht,'color','r');</span>
0380     
0381     <a href="#_sub4" class="code" title="subfunction dotrafficlights(tlcol,ht,figh);">dotrafficlights</a>(TL.stop,ht,figh);
0382     
0383     <span class="comment">%set(ht,'edgecolor','r');</span>
0384     <a href="#_sub3" class="code" title="subfunction updatefigs">updatefigs</a>;
0385     disp(ps{istim});
0386     disp([<span class="string">'&lt;CODE&gt; '</span> cs{istim}]);
0387     set(htinfo(2),<span class="string">'string'</span>,[int2str(istim) <span class="string">' : '</span> cs{istim}]);
0388     finished=0;
0389     freecomment=<span class="string">'%['</span>;
0390     
0391     <span class="keyword">while</span> ~finished
0392         mycmd=abartstr(<span class="string">'Command: '</span>,<span class="string">'n'</span>);
0393         <span class="comment">%      mycmd=lower(mycmd);</span>
0394         <span class="keyword">if</span> mycmd==<span class="string">'h'</span> <a href="#_sub5" class="code" title="subfunction showhelp">showhelp</a>; <span class="keyword">end</span>;
0395         
0396         <span class="keyword">if</span> mycmd==<span class="string">'n'</span>
0397             <span class="comment">%dotrafficlights(TL.getready,ht,figh);</span>
0398             
0399             <span class="comment">%drawnow;</span>
0400             
0401             <span class="comment">%use mysound????, what about scaling????</span>
0402             <span class="comment">%audio output from list here</span>
0403             <span class="keyword">if</span> ~isempty(wavlist)
0404                 <span class="keyword">try</span>
0405                     tmpname=deblank(wavlist(istim,:));
0406                     [audioprompt,audiopromptsf]=wavread(tmpname);
0407                     sound(audioprompt,audiopromptsf,16);
0408                     <span class="keyword">if</span> wavlistsynch pause(length(audioprompt)/audiopromptsf); <span class="keyword">end</span>;
0409                     
0410                 <span class="keyword">catch</span>
0411                     disp(<span class="string">'problem playing audio'</span>);
0412                 <span class="keyword">end</span>;
0413             <span class="keyword">end</span>;
0414             
0415             <span class="keyword">if</span> ~isempty(userstartfunc)
0416                 eval(userstartfunc,<span class="string">'disp(''Error evaluating userstartfunc'');disp(lasterr)'</span>);
0417             <span class="keyword">end</span>;
0418             
0419             
0420             <span class="comment">%finish off last comment</span>
0421             status=fwrite(fid,[rubbishstr freecomment <span class="string">']'</span> crlf],<span class="string">'uchar'</span>);
0422             freecomment=<span class="string">''</span>;
0423             rubbishstr=<span class="string">''</span>;
0424             
0425             iruns=int2str(irun);
0426             set(htinfo(1),<span class="string">'string'</span>,iruns,<span class="string">'color'</span>,htinfostopcol);
0427             drawnow;
0428             sx=int2str([irun istim]);
0429             
0430             
0431             
0432             <span class="keyword">if</span> ~isempty(wavstart)
0433                 soundsc(wavstart_d,wavstart_sf,wavstart_bits);
0434                 <span class="keyword">if</span> ~wavstart_async
0435                     tmppause=length(wavstart_d)/wavstart_sf;
0436                     pause(tmppause);
0437                 <span class="keyword">end</span>;
0438             <span class="keyword">end</span>;
0439             
0440             disp([<span class="string">'Recording '</span> int2str([irun istim])]);
0441             
0442             
0443             <span class="comment">% Start Recording</span>
0444             DAQData=zeros(datsize,nchan);
0445             <span class="comment">%pack</span>
0446             nSampsAcquired=0;
0447             disp(<span class="string">'Starting NIDAQ aquisition'</span>);
0448             daqdatindex=daqdatindex+1; 
0449             daqOutFile=[daqNameCommon int2str0vec(daqdatindex)];
0450 
0451             NIsession.startBackground;
0452             <span class="comment">%pause(0.1)</span>
0453             
0454             <span class="comment">% Start the NDI System:</span>
0455             <span class="keyword">if</span> NDIconn
0456                 p = <a href="wave_negPackage.html" class="code" title="function [p] = wave_negPackage (s,q,averbose)">wave_negPackage</a> (s,qStart);
0457             <span class="keyword">end</span>
0458             mytime=now;
0459             <span class="comment">%         set(ht,'color',[0.1 0.8 0.1]);</span>
0460             <span class="comment">%         set(ht,'edgecolor','g');</span>
0461             <a href="#_sub4" class="code" title="subfunction dotrafficlights(tlcol,ht,figh);">dotrafficlights</a>(TL.go,ht,figh);
0462             
0463             drawnow;
0464             <a href="#_sub3" class="code" title="subfunction updatefigs">updatefigs</a>;
0465             tic;
0466             <span class="comment">%if daqok putvalue(parport.Line(synchline),1); end;</span>
0467             set(htinfo(1),<span class="string">'color'</span>,htinforuncol);
0468             drawnow;
0469             <span class="keyword">if</span> isempty(trial_duration)
0470                 pause
0471             <span class="keyword">else</span>
0472                 <span class="keyword">while</span> toc&lt;trial_duration
0473                     <span class="comment">%                pause(trial_duration);</span>
0474                     pause(0.015);       <span class="comment">%no point in updating any faster</span>
0475                     set(htinfo(1),<span class="string">'string'</span>,[iruns <span class="string">' : '</span> num2str(toc,<span class="string">'%4.3f'</span>)]);
0476                     drawnow;
0477                 <span class="keyword">end</span>;
0478                 
0479             <span class="keyword">end</span>;
0480             <span class="comment">%use mysound????, what about scaling????</span>
0481             <span class="comment">%if daqok putvalue(parport.Line(synchline),0); end;</span>
0482             set(htinfo(1),<span class="string">'string'</span>,[iruns <span class="string">' : '</span> num2str(toc,<span class="string">'%4.3f'</span>)],<span class="string">'color'</span>,htinfostopcol);
0483             
0484             <span class="keyword">if</span> ~isempty(wavend)
0485                 soundsc(wavend_d,wavend_sf,wavend_bits);
0486                 <span class="keyword">if</span> ~wavend_async
0487                     tmppause=length(wavend_d)/wavend_sf;
0488                     pause(tmppause);
0489                 <span class="keyword">end</span>;
0490             <span class="keyword">end</span>;
0491             
0492             mytoc=toc;
0493             
0494             disp(<span class="string">'Stopped'</span>);
0495             <span class="comment">%pnet('closeall')</span>
0496             
0497             <span class="comment">% Stopping NDI WAVE</span>
0498             <span class="keyword">if</span> NDIconn
0499                 pStopMess = <a href="wave_negPackage.html" class="code" title="function [p] = wave_negPackage (s,q,averbose)">wave_negPackage</a> (s,qStop);
0500                 disp(<span class="string">'pStopMess'</span>)
0501                 disp(pStopMess)
0502                 pause(0.5)
0503             <span class="keyword">end</span>
0504             
0505             <span class="comment">% Stopping NIDAQ aquisition:</span>
0506             <span class="comment">% only do this if callback has not already stopped aquisition due to excess</span>
0507             <span class="comment">% of max. samples allocated</span>
0508             <span class="keyword">if</span> get(NIsession,<span class="string">'IsRunning'</span>)
0509                 NIsession.stop()
0510                 DAQData(nSampsAcquired+1:<span class="keyword">end</span>,:)=[];
0511                 disp([<span class="string">'recorded '</span>  num2str(nSampsAcquired/srate) <span class="string">' secs.'</span> ])                
0512                 disp([<span class="string">'saving data to '</span> daqOutFile])
0513                 save (daqOutFile,<span class="string">'DAQData'</span>,<span class="string">'nSampsAcquired'</span>,<span class="string">'srate'</span>,<span class="string">'nchan'</span>,<span class="string">'unit'</span>,<span class="string">'private'</span>);
0514                 <span class="comment">%disp('after Stopping:')</span>
0515                 <span class="comment">%get(NIsession)</span>
0516             <span class="keyword">end</span>
0517 
0518             
0519             [dodo,mytime]=strtok(datestr(mytime));
0520             sx=[sx <span class="string">' '</span> mytime];
0521             sx=[sx <span class="string">' '</span> num2str(mytoc)];
0522             
0523             <span class="keyword">if</span> ~isempty(userstopfunc)
0524                 eval(userstopfunc,<span class="string">'disp(''Error evaluating userstopfunc'');disp(lasterr)'</span>);
0525             <span class="keyword">end</span>;
0526             
0527             <span class="keyword">if</span> istim&lt;nstim
0528                 <span class="comment">%display new stimulus immediately to subject</span>
0529                 <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,ps{istim+1});
0530                 set(htinfo(2),<span class="string">'string'</span>,[int2str(istim+1) <span class="string">' : '</span> cs{istim+1}]);
0531                 
0532                 <span class="comment">%            set(ht,'color','r');</span>
0533                 <span class="comment">%            set(ht,'edgecolor','r');</span>
0534                 <a href="#_sub4" class="code" title="subfunction dotrafficlights(tlcol,ht,figh);">dotrafficlights</a>(TL.stop,ht,figh);
0535                 drawnow;
0536                 <a href="#_sub3" class="code" title="subfunction updatefigs">updatefigs</a>;
0537                 
0538             <span class="keyword">end</span>;
0539             
0540             <span class="comment">%10.03 free comment now has to be entered with explicit command</span>
0541             
0542             mycomm=[<span class="string">' ['</span> cs{istim} repeatstr ];
0543             repeatstr=<span class="string">''</span>;
0544             <span class="comment">%write trial number and time of day</span>
0545             sx=[sx mycomm];
0546             status=fwrite(fid,sx,<span class="string">'uchar'</span>);
0547             
0548             irun=irun+1;
0549             istim=istim+1;
0550             
0551             <span class="keyword">if</span> istim&lt;=nstim
0552                 disp(ps{istim});
0553                 disp([<span class="string">'&lt;CODE&gt; '</span> cs{istim}]);
0554             <span class="keyword">else</span>
0555                 disp(<span class="string">'End of stimuli'</span>);
0556                 finished=1;
0557                 <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,<span class="string">'\fontname{Helvetica}!!END!!'</span>);
0558                 set(htinfo(2),<span class="string">'string'</span>,<span class="string">''</span>);
0559                 <span class="comment">%finish off last comment</span>
0560                 status=fwrite(fid,[freecomment <span class="string">']'</span> crlf],<span class="string">'uchar'</span>);
0561                 freecomment=<span class="string">''</span>;
0562                 
0563             <span class="keyword">end</span>;
0564             
0565             
0566         <span class="keyword">end</span>;            <span class="comment">%next</span>
0567         <span class="keyword">if</span> mycmd==<span class="string">'c'</span>
0568             
0569             freecomment=philinp(<span class="string">'Comment : '</span>);
0570             freecomment=[<span class="string">'_'</span> freecomment];
0571             
0572         <span class="keyword">end</span>;
0573         
0574         
0575         <span class="keyword">if</span> mycmd==<span class="string">'q'</span>
0576             finished=1;
0577             <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,<span class="string">'\fontname{Helvetica}!!END!!'</span>);
0578             set(htinfo(2),<span class="string">'string'</span>,<span class="string">''</span>);
0579             <span class="comment">%finish off last comment</span>
0580             status=fwrite(fid,[freecomment <span class="string">']'</span> crlf],<span class="string">'uchar'</span>);
0581             freecomment=<span class="string">''</span>;            
0582         <span class="keyword">end</span>;
0583         <span class="keyword">if</span> mycmd==<span class="string">'k'</span>
0584             keyboard;
0585         <span class="keyword">end</span>;
0586         
0587         <span class="keyword">if</span> ((mycmd==<span class="string">'r'</span>) | (mycmd==<span class="string">'R'</span>))
0588             disp(<span class="string">'Repeating!!'</span>);
0589             repeatstr=<span class="string">'!!Repeat!!'</span>;
0590             rubbishstr=<span class="string">'!!Rubbish!!'</span>;   <span class="comment">%as comment is not closed until next &quot;next&quot; command this marks the trial with the problem</span>
0591             
0592             istim=istim-1;
0593             <span class="keyword">if</span> mycmd==<span class="string">'R'</span>
0594                 irun=irun-1;
0595                 disp(<span class="string">'Re-using previous trial number'</span>);
0596             <span class="keyword">end</span>;
0597             <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,<span class="string">'\fontname{Helvetica}!Repeat!'</span>);
0598             
0599             disp(<span class="string">'hit any key to continue'</span>);
0600             pause
0601             <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,ps{istim});
0602             <a href="#_sub4" class="code" title="subfunction dotrafficlights(tlcol,ht,figh);">dotrafficlights</a>(TL.stop,ht,figh);
0603             disp(ps{istim});
0604             disp([<span class="string">'&lt;CODE&gt; '</span> cs{istim}]);
0605             set(htinfo(2),<span class="string">'string'</span>,[int2str(istim) <span class="string">' : '</span> cs{istim}]);
0606             
0607         <span class="keyword">end</span>;
0608         
0609         <span class="keyword">if</span> mycmd==<span class="string">'g'</span>
0610             istim=abart(<span class="string">'New stimulus number'</span>,istim,1,nstim,abint,abscalar);
0611             <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,<span class="string">'\fontname{Helvetica}!Change of Stimulus!'</span>);
0612             rubbishstr=[<span class="string">'!!Stimulus number changed to '</span> int2str(istim) <span class="string">' !!'</span>];
0613             repeatstr=<span class="string">'!!May be first of several repeats!!'</span>;
0614             
0615             disp(<span class="string">'hit any key to continue'</span>);
0616             pause
0617             <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,ps{istim});
0618             <a href="#_sub4" class="code" title="subfunction dotrafficlights(tlcol,ht,figh);">dotrafficlights</a>(TL.stop,ht,figh);
0619             disp(ps{istim});
0620             disp([<span class="string">'&lt;CODE&gt; '</span> cs{istim}]);
0621             set(htinfo(2),<span class="string">'string'</span>,[int2str(istim) <span class="string">' : '</span> cs{istim}]);
0622             
0623         <span class="keyword">end</span>;
0624         
0625         <span class="keyword">if</span> mycmd==<span class="string">'m'</span>
0626             set(ht,<span class="string">'visible'</span>,<span class="string">'off'</span>);
0627             mymess=philinp(<span class="string">'Enter message to subject '</span>);
0628             mymess=rv2strm(mymess,crlf);
0629             <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,mymess);
0630             set(ht,<span class="string">'visible'</span>,<span class="string">'on'</span>,<span class="string">'edgecolor'</span>,<span class="string">'m'</span>);
0631             
0632         <span class="keyword">end</span>;
0633         <span class="keyword">if</span> mycmd==<span class="string">'M'</span>
0634             set(ht,<span class="string">'visible'</span>,<span class="string">'off'</span>);
0635             mymess=philinp(<span class="string">'Enter message to subject '</span>);
0636             mymess=rv2strm(mymess,crlf);
0637             <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,mymess);
0638             set(ht,<span class="string">'visible'</span>,<span class="string">'on'</span>,<span class="string">'edgecolor'</span>,<span class="string">'m'</span>);
0639             disp(<span class="string">'hit any key to continue'</span>);
0640             pause
0641             <a href="#_sub2" class="code" title="subfunction showg(ht,mys);">showg</a>(ht,ps{istim});
0642             <a href="#_sub4" class="code" title="subfunction dotrafficlights(tlcol,ht,figh);">dotrafficlights</a>(TL.stop,ht,figh);
0643             
0644             <span class="comment">%   set(ht,'edgecolor','r');</span>
0645             disp(ps{istim});
0646             disp([<span class="string">'&lt;CODE&gt; '</span> cs{istim}]);
0647             
0648         <span class="keyword">end</span>;
0649         <span class="keyword">if</span> mycmd==<span class="string">'d'</span>
0650             disp(<span class="string">'Enter new trial duration'</span>);
0651             trial_duration=abart(<span class="string">'New duration'</span>,trial_duration,1,999,abnoint,abscalar);
0652             status=fwrite(fid,[<span class="string">'&lt;Trial Duration changed to '</span> num2str(trial_duration) <span class="string">'&gt;'</span> crlf],<span class="string">'uchar'</span>);
0653         <span class="keyword">end</span>;
0654         
0655     <span class="keyword">end</span>;
0656     mystr=abartstr(<span class="string">'Terminate ? '</span>,<span class="string">'y'</span>);
0657     mystr=lower(mystr);
0658     
0659     <span class="keyword">if</span> mystr~=<span class="string">'n'</span> all_done=1; <span class="keyword">end</span>;
0660 <span class="keyword">end</span>;
0661 
0662 status=fclose(fid);
0663 
0664 disp(<span class="string">'hit any key to exit program'</span>);
0665 pause;
0666 
0667 <span class="comment">% clean up</span>
0668 hfinv=findobj(<span class="string">'type'</span>,<span class="string">'figure'</span>,<span class="string">'name'</span>,<span class="string">'Investigator'</span>);
0669 delete([hfsub;hfinv]);
0670 
0671 hfDAQFound=findobj(<span class="string">'Tag'</span>,<span class="string">'hfDAQ'</span>);
0672 delete(hfDAQFound)
0673 
0674 
0675 <span class="keyword">if</span> NDIconn
0676     s.close;
0677     clear s;
0678 <span class="keyword">end</span>
0679 
0680 delete(lh)
0681 clear NIsession
0682 daqreset
0683 
0684 
0685 <span class="comment">% if daqok</span>
0686 <span class="comment">%     delete(parport);</span>
0687 <span class="comment">%     clear parport;</span>
0688 <span class="comment">% end;</span>
0689 
0690 
0691 
0692 
0693 <a name="_sub3" href="#_subfunctions" class="code">function showg(ht,mys);</a>
0694 <span class="comment">%note: other version have third input argument to flag vt220 control</span>
0695 <span class="comment">%08.11 only automatically turn visibility on at end if current visibility</span>
0696 <span class="comment">%is on</span>
0697 <span class="comment">%Not yet sure this will work properly if mixing image and text prompts</span>
0698 <span class="comment">%imageprefix='&lt;IMAGE&gt;';</span>
0699 
0700 oldhtvis=get(ht(1),<span class="string">'visible'</span>);      <span class="comment">%if current visibility is 'off' (e.g because of action in userstopfunc, leave off at end)</span>
0701 hfsub=findobj(<span class="string">'type'</span>,<span class="string">'figure'</span>,<span class="string">'name'</span>,<span class="string">'Subject'</span>);
0702 P=get(hfsub,<span class="string">'userdata'</span>);
0703 
0704 hi=findobj(<span class="string">'type'</span>,<span class="string">'image'</span>,<span class="string">'tag'</span>,P.imageprefix);
0705 oldhivis=<span class="string">''</span>;
0706 <span class="keyword">if</span> ~isempty(hi) 
0707     oldhivis=get(hi,<span class="string">'visible'</span>);
0708     set(hi,<span class="string">'visible'</span>,<span class="string">'off'</span>); 
0709 <span class="keyword">end</span>;
0710 hai=findobj(<span class="string">'type'</span>,<span class="string">'axes'</span>,<span class="string">'tag'</span>,P.imageprefix);
0711 
0712 set(ht,<span class="string">'visible'</span>,<span class="string">'off'</span>);
0713 
0714 mysc=char(mys);
0715 <span class="keyword">if</span> findstr(P.imageprefix,mysc(1,:))
0716     
0717     <span class="keyword">if</span> ~isempty(hi)
0718         tmp=strrep(mysc(1,:),P.imageprefix,<span class="string">''</span>);
0719         imnum=str2num(tmp);
0720         <span class="keyword">if</span> ~isempty(imnum)
0721             <span class="keyword">if</span> ~isempty(hai)
0722                 imdata=get(hai(1),<span class="string">'userdata'</span>);
0723                 <span class="keyword">if</span> iscell(imdata)
0724                     imdata=imdata{imnum};
0725                     set(hi,<span class="string">'cdata'</span>,imdata);
0726                     <span class="keyword">if</span> strcmp(oldhivis,<span class="string">'on'</span>)
0727                         set(hi,<span class="string">'visible'</span>,<span class="string">'on'</span>);     <span class="comment">%handle axes visibility the same?</span>
0728                     <span class="keyword">end</span>;
0729                     
0730                     set(hai,<span class="string">'visible'</span>,<span class="string">'on'</span>);
0731                     P.promptmode=<span class="string">'image'</span>;
0732                     set(hfsub,<span class="string">'userdata'</span>,P)
0733                     drawnow;
0734                     <a href="#_sub3" class="code" title="subfunction updatefigs">updatefigs</a>;
0735                     <span class="keyword">return</span>;
0736                 <span class="keyword">end</span>;
0737             <span class="keyword">end</span>;
0738         <span class="keyword">end</span>;
0739     <span class="keyword">end</span>;
0740     
0741 <span class="keyword">end</span>;
0742 
0743 <span class="comment">%if image display not possible, treat as normal text display</span>
0744 
0745 
0746 <span class="comment">%normal text display</span>
0747 
0748 <span class="comment">%turn off axes containing image if last prompt was image</span>
0749 <span class="keyword">if</span> strcmp(P.promptmode,<span class="string">'image'</span>)
0750     set(hai,<span class="string">'visible'</span>,<span class="string">'off'</span>);
0751     <span class="comment">%    hfinv=findobj('type','figure','name','Investigator');</span>
0752     <span class="comment">%    set([hfsub hfinv],'color',P.figurebasecolor);</span>
0753 <span class="keyword">end</span>;
0754 
0755 P.promptmode=<span class="string">'text'</span>;
0756 set(hfsub,<span class="string">'userdata'</span>,P);
0757 
0758 tmpsize=get(ht(1),<span class="string">'userdata'</span>);
0759 set(ht,<span class="string">'fontsize'</span>,tmpsize);
0760 set(ht,<span class="string">'string'</span>,mys);
0761 eee=get(ht(1),<span class="string">'extent'</span>);
0762 ppp=get(ht(1),<span class="string">'position'</span>);
0763 
0764 maxex=max(eee(3:4));
0765 <span class="keyword">if</span> maxex&gt;1
0766     disp([<span class="string">'Reducing font to fit ['</span>, num2str(1/maxex), <span class="string">']'</span>]);
0767     <span class="comment">%disp(1/maxex);</span>
0768     tmpsize=get(ht(1),<span class="string">'fontsize'</span>)*(1/maxex);
0769     set(ht,<span class="string">'fontsize'</span>,tmpsize);
0770     eee=get(ht(1),<span class="string">'extent'</span>);
0771 <span class="keyword">end</span>;
0772 
0773 xe=eee(3);
0774 <span class="comment">%disp('extent');</span>
0775 <span class="comment">%disp(eee);</span>
0776 
0777 
0778 halign=get(ht(1),<span class="string">'horizontalalignment'</span>);
0779 <span class="keyword">if</span> strcmp(halign,<span class="string">'left'</span>)
0780     ppp(1)=0.5-xe/2;
0781 <span class="keyword">else</span>
0782     ppp(1)=0.5;
0783 <span class="keyword">end</span>;
0784 
0785 
0786 set(ht,<span class="string">'position'</span>,ppp);
0787 
0788 <span class="comment">%disp('position')</span>
0789 <span class="comment">%disp(ppp);</span>
0790 <span class="comment">%disp('axes x/y lim');</span>
0791 <span class="comment">%disp([get(gca,'xlim') get(gca,'ylim')]);</span>
0792 
0793 <span class="keyword">if</span> strcmp(oldhtvis,<span class="string">'on'</span>)
0794     set(ht,<span class="string">'visible'</span>,<span class="string">'on'</span>);
0795 <span class="keyword">end</span>;
0796 
0797 drawnow;
0798 <a href="#_sub3" class="code" title="subfunction updatefigs">updatefigs</a>;
0799 
0800 <a name="_sub4" href="#_subfunctions" class="code">function updatefigs</a>
0801 <span class="keyword">return</span>;    <span class="comment">%disabled</span>
0802 hfi=findobj(<span class="string">'type'</span>,<span class="string">'figure'</span>,<span class="string">'name'</span>,<span class="string">'Investigator'</span>);
0803 
0804 <span class="keyword">if</span> isempty(hfi) <span class="keyword">return</span>; <span class="keyword">end</span>;        <span class="comment">%assume separate figure not needed</span>
0805 
0806 hfs=findobj(<span class="string">'type'</span>,<span class="string">'figure'</span>,<span class="string">'name'</span>,<span class="string">'Subject'</span>);
0807 
0808 ppps=get(hfs,<span class="string">'position'</span>);
0809 pppi=get(hfi,<span class="string">'position'</span>);
0810 
0811 set(hfs,<span class="string">'position'</span>,ppps);    <span class="comment">%must have been a typo here</span>
0812 set(hfi,<span class="string">'position'</span>,pppi);
0813 
0814 <span class="keyword">return</span>;
0815 
0816 figure(hf);
0817 
0818 refresh(hf);
0819 drawnow;
0820 
0821 <span class="comment">%ppos=get(0,'pointerlocation');</span>
0822 <span class="comment">%fpos=get(hf,'position');</span>
0823 <span class="comment">%newpos=ppos;</span>
0824 <span class="comment">%newpos=[fpos(1)+fpos(3)/2 fpos(2)+fpos(4)/2];</span>
0825 <span class="comment">%set(0,'pointerlocation',newpos);</span>
0826 hf=findobj(<span class="string">'type'</span>,<span class="string">'figure'</span>,<span class="string">'name'</span>,<span class="string">'Subject'</span>);
0827 figure(hf);
0828 refresh(hf);
0829 drawnow;
0830 <span class="comment">%set(0,'pointerlocation',ppos);</span>
0831 
0832 <a name="_sub5" href="#_subfunctions" class="code">function dotrafficlights(tlcol,ht,figh);</a>
0833 P=get(figh(1),<span class="string">'userdata'</span>);
0834 
0835 <span class="keyword">if</span> strcmp(P.promptmode,<span class="string">'text'</span>)
0836     oldcol=get(ht(1),<span class="string">'edgecolor'</span>);
0837     <span class="keyword">if</span> any(oldcol~=tlcol) set(ht,<span class="string">'edgecolor'</span>,tlcol); <span class="keyword">end</span>;
0838 <span class="keyword">end</span>;
0839 <span class="keyword">if</span> strcmp(P.promptmode,<span class="string">'image'</span>)
0840     hai=findobj(<span class="string">'type'</span>,<span class="string">'axes'</span>,<span class="string">'tag'</span>,P.imageprefix);
0841     oldcol=get(hai(1),<span class="string">'color'</span>);
0842     <span class="keyword">if</span> any(oldcol~=tlcol) set(hai,<span class="string">'color'</span>,tlcol); <span class="keyword">end</span>;
0843     <span class="comment">%    oldcol=get(figh(1),'color');</span>
0844     <span class="comment">%    if any(oldcol~=tlcol) set(figh,'color',tlcol); end;</span>
0845 <span class="keyword">end</span>;
0846 <a name="_sub6" href="#_subfunctions" class="code">function showhelp</a>
0847 helpstr=str2mat(<span class="keyword">...</span>
0848     <span class="string">'Commands are:'</span>,<span class="keyword">...</span>
0849     <span class="string">'n = next (default)'</span>,<span class="keyword">...</span>
0850     <span class="string">'c = comment'</span>,<span class="keyword">...</span>
0851     <span class="string">'d = set trial duration'</span>,<span class="keyword">...</span>
0852     <span class="string">'r = repeat'</span>,<span class="keyword">...</span>
0853     <span class="string">'R = repeat with old trial number'</span>,<span class="keyword">...</span>
0854     <span class="string">'g = goto'</span>,<span class="keyword">...</span>
0855     <span class="string">'m = message'</span>,<span class="keyword">...</span>
0856     <span class="string">'M = message and resume'</span>,<span class="keyword">...</span>
0857     <span class="string">'q = quit'</span>,<span class="keyword">...</span>
0858     <span class="string">'k = keyboard'</span>,<span class="keyword">...</span>
0859     <span class="string">'h = help'</span>);
0860 disp(helpstr);
0861 helpwin(helpstr,<span class="string">'Prompt commands'</span>);
0862 
0863 <span class="comment">%    'a = autonext',...</span>
0864 <span class="comment">%    't = set trial number',...</span></pre></div>
<hr><address>Generated on Wed 30-Jan-2013 17:04:26 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>