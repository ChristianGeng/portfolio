function Data = LoadAmp(AmpFileName,dataspec);
% LOADAMP Load AG500 amplitude data
% function Data = LoadAmp(AmpFileName,dataspec);
% loadamp: Version 24.02.2012
%
%   Description
%       Load AG500 amplitude data from the given file (either .mat or raw binary with .amp extension).
%       Returns a 3d data matrix arranged nsamp*ntrans*nkanal
%       Give file name without extension.
%       If mat file is found, the data variable is read, and the function
%       returns.
%       If .mat file is not found, tries to open .amp file.
%       The arrangement of the data can be specified in the optional second input
%       argument, arranged [ntrans nsensor].
%       However, if this is not present the function tries to open an ini
%       file of the same name as the amp file.
%       This is parsed to determine the number of sensors (channels) and
%       the number of transmitters.
%       If no second argument is present and no ini file is found, then
%       defaults for the AG500 are used (12 channels, 6 transmitters).
%       (For AG501 files the data will have 9 transmitters. The number of
%       channels will depend on the hardware configuration.)
%       If no mat or amp file is found Data is returned empty
%
%   Updates
%       2.2012 handle ag500 and ag501
%
%   See Also
%       LOADPOS, PARSEAGINIFILE

%default to AG500
Ndim=6;     %Number of transmitters
Nchan=12;

fileext='.amp';

Data=[];


if exist([AmpFileName '.mat'],'file')
    S=load(AmpFileName);
    %in future allow all variables in mat file to be returned in the structure
    Data=double(S.data);
    return;
    
else
    
    [fid, msg] = fopen([AmpFileName fileext], 'r');	% open data file
    if fid == -1,
        disp([msg ' Filename: ' AmpFileName]);
        return;
    end
    
    [RawData, DSize] = fread(fid, inf, 'single');	% read raw data
    fclose(fid);
    
    if nargin>1
        Ndim=dataspec(1);
        Nchan=dataspec(2);
    else
        %try and read ini file
        S=parseaginifile(AmpFileName);
        if ~isempty(S)
            Ndim=S.ntrans;
            Nchan=S.nchan;
        end;
        
    end;
    
    
    Ncol=Nchan*Ndim;
    
    
    NumSamples = floor(length(RawData) / Ncol);
    
    if mod(length(RawData), Ncol) ~= 0
        disp('WARNING: File length is not a whole-numbered multiple of sample length!!!')
    end
    
    Data=(reshape(RawData,[Ncol NumSamples]))';
    
    Data=reshape(Data,[NumSamples Ndim Nchan]);
    
end;
