function timeout=prompter_getemaall(quietflag)
% function tineout=prompter_getemaall(quietflag)
%   quietflag: optional. if true, suppress text output to command window

timeout=0;
bequiet=0;
if nargin bequiet=quietflag; end;

AG=prompter_gagd;

lidatimeout=200;
readok=0;
retry = 0;
while ~readok
    try
        retry=retry+1;
        %timeout variable??
        s = lida_connect(lidatimeout);
        pause(0.2);
        %some way to avoid double read??
        %		[active,sample,sweep,dataS,dataC,pos] = getEmaAll (s);
        [active,sample,sweep,dataS,dataC,pos] = getEmaAll (s);
        pause(0.2)
        close(s);
        readok=1;
    catch
        if (retry >9)
            disp(lasterr);
            disp(['prompter_getemaall: No connection??' crlf 'Type return to exit to calling function']);
            disp('If possible, first make sure cs5recorder is running');
            prompter_writelogfile(['!!Timeout on TCPIP connection !!' crlf]);
        
            keyboard;
            timeout=1;
            return;
%original version carried on retrying indefinitely
            %            retry=0;
            
        end
    end
end

AG.active=active;
AG.sample=sample;
AG.sweep=sweep;
AG.dataS=dataS;
AG.dataC=dataC;
AG.pos=pos;


if ~bequiet
    pegel=round(eucdistn(dataS*1000,zeros(size(dataS))));
    
    
    disp('AG500: x y z phi theta rms(resid) spare rms(amp)*1000');
    disp(round([(1:size(pos,1))' pos pegel]));
end;
    disp(['AG500: Active, samplenum, trialnum : ' int2str([active sample sweep])]);

prompter_sagd(AG);
